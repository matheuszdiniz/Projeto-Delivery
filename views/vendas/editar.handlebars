{{#each erros}}
<div class="container alert alert-danger"><h4>{{texto}}</h4></div>
{{else}}
{{/each}}

<h1>Venda Realizada</h1>
<div class="card">
    <div class="card-body">
        <form action="/vendas/nova/" method="POST">
            <label for="cliente">Cliente: </label>
            <input type="text" name='cliente' class='form-control' value="{{venda.cliente}}" required>
            <label for="endereco">Endereço: </label>
            <input type="text" class="form-control" name='endereco' value="{{venda.endereco}}" required>
            {{#each venda.produto}}
                <div class="form-row ingrediente">
                    <div class="form-group col-md-8">
                        <label for="produto">Produto: </label>
                        <select class="form-control produto" name='produtos' onchange="calcularCusto()">
                            {{#each ../hamburguer}}
                                {{#ifEquals _id ../this}}
                                    <option selected value="{{../this.nome}}|{{../this._id}}">{{../this.nome}} || Custo: R${{../this.custoFinal}} || Venda: R${{../this.venda}}</option>
                                {{else}}
                                    <option value="{{../this.nome}}|{{../this._id}}">{{../this.nome}} || Custo: R${{../this.custoFinal}} || Venda: R${{../this.venda}}</option>
                                {{/ifEquals}}
                            {{/each}}
                        </select>
                    </div>
                <div class="form-group col-md-2">
                    <label for="quantidade">Quantidade: </label>
                    <input type="text" name="quantidade" class="form-control quantidade" onchange="calcularCusto()" value="{{lookup ../venda.quantidade @index}}" required>
                </div>
                <div class="form-group col-md-1">
                    <a class="btn btn-primary btn-sm mt-4" onclick="criarNovoIngrediente();calcularCusto();">Adicionar</a>
                </div>
                <div class="form-group col-md-1">
                    <a class="btn btn-danger btn-sm mt-4 deletarIg">Deletar</a>
                </div>
            </div>
            {{/each}}
            <div class="ingredientes"></div>
            <div class="form-row">
                <div class="form-group col-md-2">
                    <label for="custoFinal">Custo Produto: </label>
                    <input type="text" id="custoFinal" class="form-control" name="custoFinal" value="0" required>
                </div>
                <div class="form-group col-md-2">
                    <label for="entrega">Taxa de entrega: </label>
                    <input type="text" id="entrega" class="form-control" name="entrega" onchange="calcularCusto()" value="{{venda.taxa}}" required>
                </div>
                <div class="form-group col-md-2">
                    <label for="venda">Total Venda: </label>
                    <input type="text" id="venda" class="form-control" name="venda" onchange="calcularMargem()" value="{{venda.venda}}" required>
                </div>
                <div class="form-group col-md-2">
                    <label for="markup">Markup: (%)</label>
                    <input type="text" id="markup" class="form-control" name="markup" onchange="vendaMarkup()" value="{{venda.markup}}" required>
                </div>
                <div class="form-group col-md-2">
                    <label for="margem">Margem: (%)</label>
                    <input type="text" id="margem" class="form-control" name='margem' value="{{venda.margem}}" required>
                </div>
                <div class="form-group col-md-2">
                    <button type="submit" class="btn btn-success mt-4">Enviar Venda!</button>
                </div>
            </div>
        </form>
    </div>
</div>
<form method="POST" action="../deletar/{{venda._id}}" class="d-inline">
    <button type="submit" class="btn btn-outline-danger btn-sm">Deletar</button>
</form>

<script>
    let ingredienteVindo = document.getElementsByClassName('ingredienteVindo')
    Array.from(ingredienteVindo).forEach(element =>{
        element.innerText = element.innerText.split("$")[0] + "$" + Number.parseFloat(((element.innerText).split("$")[1]).split("¬")[0]) / Number.parseFloat(((element.innerText).split("$")[1]).split("¬")[1])
    })
    let ingrediente = document.getElementsByClassName("ingrediente")[0]
    let indice = document.getElementsByClassName("ingrediente").length + 1
    let indices = document.getElementsByClassName("ingrediente").length + 1
    let indiceBotao = document.getElementsByClassName("ingrediente").length + 1
    const criarNovoIngrediente = ()=> {
        let ingredientes = document.getElementsByClassName("ingredientes")[0]
        let clone = ingrediente.cloneNode(true)
        clone.setAttribute('id', indice)
        ingredientes.appendChild(clone)
        let deletarIg = document.getElementsByClassName("deletarIg")[indiceBotao - 1]
        deletarIg.setAttribute("onclick", "deletarIngrediente("+indice+");calcularCusto();")
        indiceBotao++
        indice++
    }
    const calcularMargem = ()=>{
        let venda = Number.parseFloat((document.getElementById('venda').value).replace(',', '.'))
        let custo = Number.parseFloat(document.getElementById('custoFinal').value)
        let margem = document.getElementById('margem')
        let markup = document.getElementById('markup')
        let calculoMargem = ((venda - custo) / venda * 100).toFixed(0)
        let calculoMarkup = (((venda / custo) - 1) * 100).toFixed(0)
        margem.value = calculoMargem
        markup.value = calculoMarkup
    }
    const calcularCusto = ()=>{
        let custo = 0
        let venda = 0
        for(i=0; i < indiceBotao - 1; i++){
            let produto = document.getElementsByClassName("produto")
            let quantidade = document.getElementsByClassName("quantidade")[i]
            venda += (Number.parseFloat(((((produto[i].options[produto[i].selectedIndex].text)).split('$'))[2]).replace(',', '.')) * Number.parseFloat((quantidade.value).replace(',', '.')))
            custo += (Number.parseFloat(((((produto[i].options[produto[i].selectedIndex].text)).split('$'))[1]).replace(',', '.')) * Number.parseFloat((quantidade.value).replace(',', '.')))
            quantidade.value = Number.parseFloat((quantidade.value).replace(',', '.')).toFixed(0)
        }
        document.getElementById('venda').value = /*(Number.parseFloat(document.getElementById('entrega').value) +*/ (venda).toFixed(2)
        document.getElementById('custoFinal').value = /*(Number.parseFloat(document.getElementById('entrega').value) +*/ (custo).toFixed(2)
        i=0
        calcularMargem()
    }
    const vendaMargem = ()=>{
        let margem = Number.parseFloat((document.getElementById('margem').value).replace(',', '.'))
        let custo = Number.parseFloat(document.getElementById('custoFinal').value)
        let venda
    }
    const vendaMarkup = ()=>{
        let markup = Number.parseFloat((document.getElementById('markup').value).replace(',', "."))
        let custo = Number.parseFloat(document.getElementById('custoFinal').value)
        let calculoVenda = (custo * ((markup / 100) + 1)).toFixed(0)
        let venda = document.getElementById('venda')
        venda.value = calculoVenda
        let lucroLiquido = calculoVenda - custo
        let calculoMargem = (lucroLiquido / calculoVenda * 100).toFixed(0)
        margem.value = calculoMargem
    }
    const deletarIngrediente = (index)=>{
        let iddIgrediente = document.getElementById(index)
        iddIgrediente.remove()
        indiceBotao--
    }
    calcularCusto()
</script>